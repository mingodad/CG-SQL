<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Developer Notes on CQL Development | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Developer Notes on CQL Development | CG/SQL"><meta data-react-helmet="true" name="description" content="1. If you aren&#x27;t good with yacc/lex you probably should do some homework before you start. CQL development is all about building and walking a syntax tree.  It&#x27;s possible to make local changes without knowing the details but it can be hard to figure out where to make changes without context."><meta data-react-helmet="true" property="og:description" content="1. If you aren&#x27;t good with yacc/lex you probably should do some homework before you start. CQL development is all about building and walking a syntax tree.  It&#x27;s possible to make local changes without knowing the details but it can be hard to figure out where to make changes without context."><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/docs/dev-notes"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/docs/dev-notes"><link rel="stylesheet" href="/styles.45b22519.css">
<link rel="preload" href="/styles.480d1f30.js" as="script">
<link rel="preload" href="/runtime~main.34082030.js" as="script">
<link rel="preload" href="/main.b815b31d.js" as="script">
<link rel="preload" href="/1.2e95473d.js" as="script">
<link rel="preload" href="/2.0c45b020.js" as="script">
<link rel="preload" href="/3.d04889a6.js" as="script">
<link rel="preload" href="/1be78505.d00e88e1.js" as="script">
<link rel="preload" href="/82.ac17f5fe.js" as="script">
<link rel="preload" href="/935f2afb.b08bf01f.js" as="script">
<link rel="preload" href="/17896441.ea9e5e3f.js" as="script">
<link rel="preload" href="/0a2aaac0.0e32d507.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Quick Start</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/building">Building CG/SQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/code-coverage">Code Coverage CG/SQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/testing">Testing CG/SQL</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Resources</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/dev-notes">Developer Notes</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Developer Notes on CQL Development</h1></header><div class="markdown"><ol><li><p>If you aren&#x27;t good with <code>yacc</code>/<code>lex</code> you probably should do some homework before you start. CQL development is all about building and walking a syntax tree.  It&#x27;s possible to make local changes without knowing the details but it can be hard to figure out where to make changes without context.</p></li><li><p>CQL development is basically test driven, to create a new feature:</p><ol><li>Add the language feature to <code>test.sql</code></li><li>run <code>test.sh</code>; it will fail due to parse error</li><li>Add the syntax to <code>cql.y</code> and create the necessary tree pieces in <code>ast.h</code></li><li>run <code>test.sh</code>; when it passes use <code>ok.sh</code> to install this as the new reference baseline.</li><li>Add a test case to <code>sem_test.sql</code> that uses your new feature. <code>sem_test.sql</code> can contain pattern matching for the semantic output.</li><li>run <code>test.sh</code>; it will fail because it will find an AST node it doesn&#x27;t understand</li><li>edit <code>sem.c</code> to do the analysis for your new node type</li><li>adjust the verification in <code>sem_test.sql</code> accordingly</li><li>run <code>test.sh</code> until it passes making fixes as needed</li><li>there will be new diff output and it will be spitting out the diffs, if you are happy with the validation and the new output run ok.sh to create new reference output; note the pattern matching validations will still fail if the output goes bad even if the reference comparison is good, the reference output is a double check</li><li>add code that uses your new feature to <code>cg_test.sql</code>, this is the code gen test, verifications using pattern matching are also allowed there</li><li>run <code>test.sh</code></li><li>it will fail because codegen doesn&#x27;t know about your new feature</li><li>edit <code>cg_c.c</code> (or a different code gen if you&#x27;re doing test helpers or some such) to support your new code</li><li>cycle running <code>test.sh</code> until it passes</li><li>run <code>ok.sh</code> when you&#x27;re happy with the diffs again</li><li>Add code that runs your new feature using run_test.sql</li><li>Run <code>test.sh</code>, if your codegen was perfect it could pass; it probably won&#x27;t at first</li><li>fix your code until it&#x27;s done; you shouldn&#x27;t need to run ok.sh at this point</li><li>run <code>cov.sh</code> to confirm 100% coverage</li><li>sanity check the GCC build (I use a linux box for this)</li></ol></li><li><p>Get a solid code review and land as usual.</p></li></ol><p>By the time you have done this you will have passed the tests dozens of times and you will know exactly what your code is doing to the entire battery of cql combinations.  Missing tests can be painful and cause downstream regressions so be ruthless about adding enough combinations and validating the essential parts.  The snapshot diffing is helpful but the real gating is done by the pattern matching logic.</p><p>Note: none of this works unless you are standing the main source directory</p><p>Note: the test scripts make a lot of turds, at this point almost everything should be going into the <code>out</code>
directory but it wasn&#x27;t always so.  You can use <code>make clean</code> to get rid of the build stuff wherever it may be.
Alternatively use source control to get rid of any junk.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/testing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Testing CG/SQL</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.480d1f30.js"></script>
<script src="/runtime~main.34082030.js"></script>
<script src="/main.b815b31d.js"></script>
<script src="/1.2e95473d.js"></script>
<script src="/2.0c45b020.js"></script>
<script src="/3.d04889a6.js"></script>
<script src="/1be78505.d00e88e1.js"></script>
<script src="/82.ac17f5fe.js"></script>
<script src="/935f2afb.b08bf01f.js"></script>
<script src="/17896441.ea9e5e3f.js"></script>
<script src="/0a2aaac0.0e32d507.js"></script>
</body>
</html>