<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Appendix 8: CQL Best Practices | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Appendix 8: CQL Best Practices | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/x8"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/x8"><link rel="stylesheet" href="/styles.45b22519.css">
<link rel="preload" href="/styles.480d1f30.js" as="script">
<link rel="preload" href="/runtime~main.34082030.js" as="script">
<link rel="preload" href="/main.b815b31d.js" as="script">
<link rel="preload" href="/1.2e95473d.js" as="script">
<link rel="preload" href="/2.0c45b020.js" as="script">
<link rel="preload" href="/3.d04889a6.js" as="script">
<link rel="preload" href="/1be78505.d00e88e1.js" as="script">
<link rel="preload" href="/82.ac17f5fe.js" as="script">
<link rel="preload" href="/5456faf3.a2899e62.js" as="script">
<link rel="preload" href="/17896441.ea9e5e3f.js" as="script">
<link rel="preload" href="/0d4e649a.be30776a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch05">Chapter 5: Types of Cursors, OUT and OUT UNION, and FETCH flavors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Appendix 8: CQL Best Practices</h1></header><div class="markdown"><p>This is a brief discussion of every statement type and some general best practices for that statement.
The statements are in mostly alphabetical order except related statements were moved up in the order
to make logical groups.</p><p>Refer also to Appendix 7: CQL Anti-patterns.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="data-definition-language-ddl"></a>Data Definition Language (DDL)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#data-definition-language-ddl" title="Direct link to heading">#</a></h3><ul><li><code>ALTER TABLE ADD COLUMN</code></li><li><code>CREATE INDEX</code></li><li><code>CREATE PROC</code></li><li><code>CREATE TABLE</code></li><li><code>CREATE TRIGGER</code></li><li><code>CREATE VIEW</code></li><li><code>CREATE VIRTUAL TABLE</code></li><li><code>DROP INDEX</code></li><li><code>DROP TABLE</code></li><li><code>DROP TRIGGER</code></li><li><code>DROP VIEW</code></li></ul><p>These statements almost never appear in normal procedures and generally should be avoided.  The normal way of handling schema in CQL
is to have one or more files declare all the schema you need and then let CQL create a schema upgrader for you.  This means you&#x27;ll
never manually drop tables or indices etc.  The <code>create</code> declarations with their annotations will totally drive the schema.</p><p>Any ad hoc DDL is usually a very bad sign.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ad-hoc-migrations"></a>Ad Hoc Migrations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ad-hoc-migrations" title="Direct link to heading">#</a></h3><ul><li><code>@SCHEMA_AD_HOC_MIGRATION</code></li></ul><p>This is a special upgrade step that should be taken at the version indicated in the statement.  These can be quite complex and even super important
but should not be used lightly.  Any migration procedure has to be highly tolerant of a variety of incoming schema versions and previous partial successes.
In any case this directive should not appear in normal code.  It should be part of the schema DDL declarations.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="transactions"></a>Transactions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#transactions" title="Direct link to heading">#</a></h3><ul><li><code>BEGIN TRANSACTION</code></li><li><code>COMMIT TRANSACTION</code></li><li><code>ROLLBACK TRANSACTION</code></li></ul><p>Transactions do not nest and most procedures do not know the context in which they will be called, so the vast majority of
procedures will not and should not actaully start transactions.  You can only do this if you know, somehow, for sure, that
the procedure in question is somehow a &quot;top level&quot; procedure.  So generally, don&#x27;t use these statements.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="savepoints"></a>Savepoints<a aria-hidden="true" tabindex="-1" class="hash-link" href="#savepoints" title="Direct link to heading">#</a></h3><ul><li><code>SAVEPOINT</code></li><li><code>ROLLBACK TO SAVEPOINT</code></li><li><code>RELEASE SAVEPOINT</code></li><li><code>PROC SAVEPOINT</code></li><li><code>COMMIT RETURN</code></li><li><code>ROLLBACK RETURN</code></li></ul><p>Savepoints are the preferred tool for having interim state that can be rolled back if needed.  You can use ad hoc
savepoints, just give your save point and name then use <code>RELEASE SAVEPOINT</code> to commit it, or else <code>ROLLBACK TO SAVEPOINT</code>
followed by a <code>RELEASE</code> to abort it.  Note that you always <code>RELEASE</code> savepoints in both the rollback and the commit case.</p><p>Managing savepoints can be tricky, especially given the various error cases.  They combine nicely with <code>TRY CATCH</code> to do
this job.  However, even that is a lot of boilerplate.  The best way to use savepoints is with <code>PROC SAVEPOINT BEGIN</code> .. <code>END</code>;</p><p>When you use <code>PROC SAVEPOINT</code>, a savepoint is created for you with the name of your procedure.  When the block exits
the savepoint is released (committed).  However you also get an automatically generated try/catch block which will
rollback the savepoint if anything inside the block were to invoke <code>THROW</code>.  Also, you may not use a regular <code>RETURN</code>
inside this block, you must use either <code>ROLLBACK RETURN</code> or <code>COMMIT RETURN</code>.  Both of these directly indicate the fate
of the automatically generated statement when they run.  This gives you useful options to early-out (with no error)
while keeping or abandoning any work in progress.  Of course you can use <code>THROW</code> to return an error and
abandon the work in progress.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="compilation-options"></a>Compilation options<a aria-hidden="true" tabindex="-1" class="hash-link" href="#compilation-options" title="Direct link to heading">#</a></h3><ul><li><code>@ENFORCE_NORMAL</code></li><li><code>@ENFORCE_POP</code></li><li><code>@ENFORCE_PUSH</code></li><li><code>@ENFORCE_RESET</code></li><li><code>@ENFORCE_STRICT</code></li></ul><p>CQL allows you to specify a number of useful options such as &quot;do not allow Window Functions&quot; or &quot;all foreign keys must choose some update or delete strategy&quot;.
These additional enforcements are designed to prevent errors.  Because of this they should be established once, somewhere central and they should be rarely
if ever overrided.  For instance <code>@ENFORCE_NORMAL WINDOW FUNCTION</code> would allow you to use window functions again, but this is probably a bad idea. If
strict mode is on, disallowing them, that probably means your project is expected to target versions of SQLite that do not have window functions.  Overriding
that setting is likely to lead to runtime errors.</p><p>In general you don&#x27;t want to see these options in most code.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="previous-schema"></a>Previous Schema<a aria-hidden="true" tabindex="-1" class="hash-link" href="#previous-schema" title="Direct link to heading">#</a></h3><ul><li><code>@PREVIOUS_SCHEMA</code></li></ul><p>CQL can ensure that the current schema is compatible with the previous schema, meaning that an upgrade script could reasonably be generated to go from the
previous to the current.  This directive demarks the start of the previous schema section when that validatio happens.  This direcive is useless except
for creating that schema validation so it should never appear in normal procedures.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="schema-regions"></a>Schema Regions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#schema-regions" title="Direct link to heading">#</a></h3><ul><li><code>@BEGIN_SCHEMA_REGION</code></li><li><code>@DECLARE_DEPLOYABLE_REGION</code></li><li><code>@DECLARE_SCHEMA_REGION</code></li><li><code>@END_SCHEMA_REGION</code></li></ul><p>CQL allows you to declare arbitrary schema regions and limit what parts of the schema any given region may consume.  This helps you to prevent schema from getting
entangled.  There is never a reason to use this directives inside normal procedures;  They should appear only in your schema declaration files.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="schema-version"></a>Schema Version<a aria-hidden="true" tabindex="-1" class="hash-link" href="#schema-version" title="Direct link to heading">#</a></h3><ul><li><code>@SCHEMA_UPGRADE_SCRIPT</code></li><li><code>@SCHEMA_UPGRADE_VERSION</code></li></ul><p>The <code>@SCHEMA_UPGRADE_SCRIPT</code> directive is only used by CQL itself to declare that the incoming file is an autogenerated schema upgrade script.
These scripts have slightly different rules for schema declaration that are not useful outside of such scripts.  So you should never use this.</p><p><code>@SCHEMA_UPGRADE_VERSION</code> on the other hand is used if you are creating a manual migration script.  You need this script to run in the context
of the schema version that it affects.  Use this directive at the start of the file to do so.  Generally manual migration scripts are to be
avoided so hopefully this directive is rarely if ever used.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="c-text-echo"></a>C Text Echo<a aria-hidden="true" tabindex="-1" class="hash-link" href="#c-text-echo" title="Direct link to heading">#</a></h3><ul><li><code>@ECHO</code></li></ul><p>This directive emits plain text directly into the compiler&#x27;s output stream.  It can be invaluable for adding new runtime features and for ensuring that
(e.g.) additional <code>#include</code> or <code>#define</code> directives are present in the output but you can really break things by over-using this feature.  Most parts
of the CQL output are subject to change so any use of this should be super clean.  The indended use was, as mentioned, to allow an extra <code>#include</code> in your code
so that CQL could call into some library.  Most uses of this combine with <code>DECLARE FUNCTION</code> or <code>DECLARE PROCEDURE</code> to declare an external entity.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="enumerations"></a>Enumerations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#enumerations" title="Direct link to heading">#</a></h3><ul><li><code>DECLARE ENUM</code></li><li><code>@EMIT_ENUMS</code></li></ul><p>Avoid embedded constants whenever possible.  Instead declare a suitable enumeration.   Use <code>@EMIT_ENUMS Some_Enum</code> to get the enumeration
constants into the generated .h file for C. But be sure to do this only from one compiland.  You do not want the enumerations in every .h file.
Choose a single .sql file (not included by lots of other things) to place the <code>@EMIT_ENUMS</code> directive. You can make a file specifically for this
purpose if nothing else is serviceable.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cursor-lifetime"></a>Cursor Lifetime<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cursor-lifetime" title="Direct link to heading">#</a></h3><ul><li><code>CLOSE</code></li><li><code>OPEN</code></li></ul><p>The <code>OPEN</code> statement is a no-op, SQLite has no such notion.  It was included becasue it is present in <code>MYSQL</code> and other variants and its inclusion can
easy readability sometimes.  But it does nothing.   The <code>CLOSE</code> statement is normally not necessary because all cursors are closed at the end of the
procedure they are declared in (unless they are boxed, see below).  You only need <code>CLOSE</code> if you want to close a global cursor (which has no scope)
or if you want to close a local cursor &quot;sooner&quot; because waiting to the end of the procedure might be a very long time.  Using close more than once
is safe, the second and later close operations do nothing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="procedure-calls-and-exceptions"></a>Procedure Calls and Exceptions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#procedure-calls-and-exceptions" title="Direct link to heading">#</a></h3><ul><li><code>CALL</code></li><li><code>THROW</code></li><li><code>TRY CATCH</code></li></ul><p>Remember that if you call a procedure and it uses <code>THROW</code> or else uses some SQL that failed, this return code will cause your
code to <code>THROW</code> when the procedure returns.  Normally that&#x27;s exactly what you want, the error will ripple out and some top-level
<code>CATCH</code> will cause a <code>ROLLBACK</code> and the top level callers sees the error.  If you have your own rollback needs be sure to install
your own <code>TRY</code>/<code>CATCH</code> block or else use <code>PROC SAVEPOINT</code> as above to do it for you.</p><p>Inside of a <code>CATCH</code> block you can use the special variable <code>@RC</code> to see the most recent return code from SQLite.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="control-flow-with-big-moves"></a>Control Flow with &quot;Big Moves&quot;<a aria-hidden="true" tabindex="-1" class="hash-link" href="#control-flow-with-big-moves" title="Direct link to heading">#</a></h3><ul><li><code>CONTINUE</code></li><li><code>LEAVE</code></li><li><code>RETURN</code></li></ul><p>These work as usual but beware, you can easily use any of these to accidentally leave a block with a savepoint or transaction
and you might skip over the <code>ROLLBACK</code> or <code>COMMIT</code> portions of the logic.  Avoid this problem by using <code>PROC SAVEPOINT</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="getting-access-to-external-code"></a>Getting access to external code<a aria-hidden="true" tabindex="-1" class="hash-link" href="#getting-access-to-external-code" title="Direct link to heading">#</a></h3><ul><li><code>DECLARE FUNCTION</code></li><li><code>DECLARE SELECT FUNCTION</code></li><li><code>DECLARE PROCEDURE</code></li></ul><p>The best practice is to put any declarations into a shared header file which you can <code>#include</code> in all the places it is needed.
This is especially important should you have to forward declare a procedure.  CQL normally provides exports for all procedures
so you basically get an automatically generated and certain-to-be-correct <code>#include</code> file.  But, if the procedures are being compiled
together then an export file won&#x27;t have been generated yet at the time you need it;  To work around this you use the <code>DECLARE PROCEDURE</code>
form.  However, procedure declarations are tricky;  they include not just the type of the arguments but the types of any/all of the
columns in any result set the procedure might have.  This must not be wrong or callers will get unpredictable failures.</p><p>The easiest way to ensure it is correct is to use the same trick as you would in C -- make sure that you <code>#include</code> the declaration
the in the translation unit with the definition.  If they don&#x27;t match there will be an error.</p><p>A very useful trick: the error will include the exact text of the correct declaration.  So if you don&#x27;t know it, or are too lazy to
figure it out; simply put <code>ANY</code> declaration in the shared header file and then paste in the correct declaration from the error.  should
the definition ever change you will get a compilation error which you can again harvest to get the correct declaration.</p><p>In this way you can be sure the declarations are correct.</p><p>Functions have no CQL equivalent, but they generally don&#x27;t change very often.  Use <code>DECLARE FUNCTION</code> to allow access to some C code
that returns a result of some kind.   Be sure to add the <code>CREATE</code> option if the function returns a reference that the caller owns.</p><p>Use <code>DECLARE SELECT FUNCTION</code> to tell CQL about any User Defined Functions you have added to SQLite so that it knows how to call them.
Note that CQL does not register those UDFs, it couldn&#x27;t make that call lacking the essential C information required to do so.  If you
find that you are getting errors when calling a UDF the most likely reason for the failure is that the UDF was declared but never
registered with SQLite at runtime.  This happens in test code a lot -- product code tends to have some central place to register the
UDFs and it normally runs at startup, e.g. right after the schema is upgraded.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="regular-data-manipulation-language-dml"></a>Regular Data Manipulation Language (DML)<a aria-hidden="true" tabindex="-1" class="hash-link" href="#regular-data-manipulation-language-dml" title="Direct link to heading">#</a></h3><ul><li><code>DELETE</code></li><li><code>INSERT</code></li><li><code>SELECT</code></li><li><code>UPDATE</code></li><li><code>UPSERT</code></li></ul><p>These statements are the most essential and they&#x27;ll appear in almost every procedure. There are a few general best practices we can go over.</p><ul><li><p>Try to do as much as you can in one batch rather than iterating;  e.g.</p><ul><li>don&#x27;t write a loop with a <code>DELETE</code> statement that deletes one row if you can avoid it, write a delete statement that deletes all you need to delete</li><li>don&#x27;t write a loop with of <code>SELECT</code> statement that fetches one row, try to fetch all the rows you need with one select</li></ul></li><li><p>Make sure <code>UPSERT</code> is supported on the SQLite system you are using, older versions do not support it</p></li><li><p>Don&#x27;t put unnecessary casts in your <code>SELECT</code> statements, they just add fat</p></li><li><p>Don&#x27;t use <code>CASE</code>/<code>WHEN</code> to compute a boolean, the boolean operations are more economical (e.g. use <code>IS</code>)</p></li><li><p>Don&#x27;t use <code>COUNT</code> if all you need to know is whether a row exists or not, use <code>EXISTS</code></p></li><li><p>Don&#x27;t use <code>GROUP BY</code>, <code>ORDER BY</code>, or <code>DISTINCT</code> on large rowsets, the sort is expensive and it will make your <code>SELECT</code> statements write to disk rather than just read</p></li><li><p>Always use the <code>INSERT INTO FOO USING</code> form of the <code>INSERT</code> statement, it&#x27;s much easier to read than the standard form and compiles to the same thing</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="variable-and-cursor-declarations"></a>Variable and Cursor declarations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#variable-and-cursor-declarations" title="Direct link to heading">#</a></h3><ul><li><code>DECLARE OUT CALL</code></li><li><code>DECLARE</code></li><li><code>LET</code></li><li><code>SET</code></li></ul><p>These are likely to appear all over as well.  If you can avoid a variable declaration by using <code>LET</code> then do so;  The code will be more concise and you&#x27;ll
get the exact variable type you need.  This is the same as <code>var x = foo();</code> in other languages.  Once the variable is declared use <code>SET</code>.</p><p>You can save yourself a lot of declarations of <code>OUT</code> variables with <code>DECLARE OUT CALL</code>.  That declaration form automatically declares the <code>OUT</code> variables used
in the call you are about to make with the correct type.  If the number of arguments changes you just have to add the args you don&#x27;t have to also add
new declarations.</p><p>The <code>LIKE</code> construct can be used to let you declare things whose type is the same as another thing.  Patterns like <code>DECLARE ARGS CURSOR LIKE FOO ARGUMENTS</code>
save you a lot of typing and also enhance correctness.  There&#x27;s a whole chapter dedicated to &quot;shapes&quot; defined by <code>LIKE</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="query-plans"></a>Query Plans<a aria-hidden="true" tabindex="-1" class="hash-link" href="#query-plans" title="Direct link to heading">#</a></h3><ul><li><code>EXPLAIN</code></li></ul><p>Explain can be used in front of other queries to generate a plan.  The way SQLite handles this is that you fetch the rows of the plan as usual.  So basically
<code>EXPLAIN</code> is kind of like <code>SELECT QUERY PLAN OF</code>.  This hardly ever comes up in normal coding.  CQL has an output option where it will generate code that gives you
the query plan for a procedures queries rather than the normal body of the procedure.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="fetching-data-from-a-cursor-or-from-loose-data"></a>Fetching Data from a Cursor or from Loose Data<a aria-hidden="true" tabindex="-1" class="hash-link" href="#fetching-data-from-a-cursor-or-from-loose-data" title="Direct link to heading">#</a></h3><ul><li><code>FETCH</code></li><li><code>UPDATE CURSOR</code></li></ul><p>The <code>FETCH</code> statement has many variations, all are useful at some time or another. There are a few helpful guidelines.</p><ul><li>If fetching from loose values into a cursor use the <code>FETCH USING</code> form (as you would with <code>INSERT INTO USING</code>) because it is less error prone</li><li><code>FETCH INTO</code> is generally a bad idea, you&#x27;ll have to declare a lot of variables, instead just rely on automatic storage in the cursor e.g.
<code>fetch my_cursor</code> rather than <code>fetch my_cursor into a, b, c</code></li><li>If you have data already in a cursor you can mutate some of the columns using <code>UPDATE CURSOR</code>, this can let you adjust values or apply defaults</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="control-flow"></a>Control Flow<a aria-hidden="true" tabindex="-1" class="hash-link" href="#control-flow" title="Direct link to heading">#</a></h3><ul><li><code>IF</code></li><li><code>LOOP</code></li><li><code>SWITCH</code></li><li><code>WHILE</code></li></ul><p>These are your bread and butter and they will appear all over.  One tip: Use the <code>ALL VALUES</code> variant of switch whenever possible to ensure that you haven&#x27;t missed any cases.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="manual-control-of-results"></a>Manual Control of Results<a aria-hidden="true" tabindex="-1" class="hash-link" href="#manual-control-of-results" title="Direct link to heading">#</a></h3><ul><li><p><code>OUT</code></p></li><li><p><code>OUT UNION</code></p></li><li><p>If you know you are producing exactly one row <code>OUT</code> is more economical than <code>SELECT</code></p></li><li><p>If you need complete flexibility on what rows to produce (e.g. skip some, add extras, mutate some) then <code>OUT UNION</code> will give you that, use it only when needed, it&#x27;s more expensive than just <code>SELECT</code></p></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-07-01T12:24:29.000Z" class="docLastUpdatedAt_217_">7/1/2021</time> by <strong>mingodad</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/x7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Appendix 7: CQL Anti-patterns</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data-definition-language-ddl" class="table-of-contents__link">Data Definition Language (DDL)</a></li><li><a href="#ad-hoc-migrations" class="table-of-contents__link">Ad Hoc Migrations</a></li><li><a href="#transactions" class="table-of-contents__link">Transactions</a></li><li><a href="#savepoints" class="table-of-contents__link">Savepoints</a></li><li><a href="#compilation-options" class="table-of-contents__link">Compilation options</a></li><li><a href="#previous-schema" class="table-of-contents__link">Previous Schema</a></li><li><a href="#schema-regions" class="table-of-contents__link">Schema Regions</a></li><li><a href="#schema-version" class="table-of-contents__link">Schema Version</a></li><li><a href="#c-text-echo" class="table-of-contents__link">C Text Echo</a></li><li><a href="#enumerations" class="table-of-contents__link">Enumerations</a></li><li><a href="#cursor-lifetime" class="table-of-contents__link">Cursor Lifetime</a></li><li><a href="#procedure-calls-and-exceptions" class="table-of-contents__link">Procedure Calls and Exceptions</a></li><li><a href="#control-flow-with-big-moves" class="table-of-contents__link">Control Flow with &quot;Big Moves&quot;</a></li><li><a href="#getting-access-to-external-code" class="table-of-contents__link">Getting access to external code</a></li><li><a href="#regular-data-manipulation-language-dml" class="table-of-contents__link">Regular Data Manipulation Language (DML)</a></li><li><a href="#variable-and-cursor-declarations" class="table-of-contents__link">Variable and Cursor declarations</a></li><li><a href="#query-plans" class="table-of-contents__link">Query Plans</a></li><li><a href="#fetching-data-from-a-cursor-or-from-loose-data" class="table-of-contents__link">Fetching Data from a Cursor or from Loose Data</a></li><li><a href="#control-flow" class="table-of-contents__link">Control Flow</a></li><li><a href="#manual-control-of-results" class="table-of-contents__link">Manual Control of Results</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.480d1f30.js"></script>
<script src="/runtime~main.34082030.js"></script>
<script src="/main.b815b31d.js"></script>
<script src="/1.2e95473d.js"></script>
<script src="/2.0c45b020.js"></script>
<script src="/3.d04889a6.js"></script>
<script src="/1be78505.d00e88e1.js"></script>
<script src="/82.ac17f5fe.js"></script>
<script src="/5456faf3.a2899e62.js"></script>
<script src="/17896441.ea9e5e3f.js"></script>
<script src="/0d4e649a.be30776a.js"></script>
</body>
</html>