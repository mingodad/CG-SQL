<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Posts tagged &quot;errors&quot; | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;errors&quot; | CG/SQL"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;errors&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;errors&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.45b22519.css">
<link rel="preload" href="/styles.480d1f30.js" as="script">
<link rel="preload" href="/runtime~main.34082030.js" as="script">
<link rel="preload" href="/main.b815b31d.js" as="script">
<link rel="preload" href="/1.2e95473d.js" as="script">
<link rel="preload" href="/2.0c45b020.js" as="script">
<link rel="preload" href="/3.d04889a6.js" as="script">
<link rel="preload" href="/6875c492.4d2a66c0.js" as="script">
<link rel="preload" href="/3e3a85bc.4f802e0d.js" as="script">
<link rel="preload" href="/80400c32.4e933fdb.js" as="script">
<link rel="preload" href="/fc3479db.6383568e.js" as="script">
<link rel="preload" href="/c3370886.e105e932.js" as="script">
<link rel="preload" href="/517fa2ac.bf08fa3f.js" as="script">
<link rel="preload" href="/7e9fb3d2.1230d0a1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><main class="col col--8 col--offset-2"><h1>5 posts tagged with &quot;errors&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/arg-bungle-intro">Introducing  Argument Bundles</a></h2><div class="margin-vert--md"><time datetime="2020-12-08T00:00:00.000Z" class="blogPostDate_3bQP">December 8, 2020  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>There are many cases where stored procedures require complex arguments using data shapes well known
to higher level languages or that come from the schema.  There is already some affordance for this
sort of thing in the form of this kind of pattern:</p><p>(I&#x27;ll continue to use this simple example as I discuss the generalization below)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table Person (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   id text primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   birthday real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>Then maybe something like this</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    birthday_ real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(id_, name_, address_, birthday_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>And I think we can all agree the sugared version is a lot easier to reason about
and much less prone to errors as well.</p><p>Those features have been in the language for a long time and that&#x27;s all fine and well
but it isn&#x27;t general enough to handle the usual mix of situations.  For instance what
if you need a procedure that works with two people?  A hypothetical <code>insert_two_people</code>
procedure cannot be written with the old form.  This is where argument bundles come in.
The idea here is to name the bundle which provides useful reference.  To wit:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>or alternatively</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>So what&#x27;s going on here?  Well, there are lots of reasons to keep the API to procedures simple
and adding general purpose structured types would be at odds with that.  It would require lots
of knowledge about C structure layout and whatnot.  And trying to call from java would require
very complex JNI for any such procedure.  So we avoid all that.  We keep simple arguments.
The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_birthday real,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_birthday real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p1_id, p1_name, p1_address, p1_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p2_id, p2_name, p2_address, p2_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>Or course the types don&#x27;t have to be the same, you can create and name shapes of your choice.  The language allow
you to use an argument bundle in all the places that a cursor was previously a valid source.  That includes <code>insert</code>,
<code>fetch</code>, <code>update cursor</code>, and procedure calls.  You can refer to the arguments by their expanded name <code>p1_address</code>
or alternatively <code>p1.address</code> means the same thing.</p><p>Here&#x27;s another example showing a silly but illustrative thing you could do:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_lotsa_people(P like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare C cursor like P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fetch C from P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while (i &lt; 20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        update cursor C using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            printf(&quot;id_%d&quot;, i) id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        insert into Person from C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above shows that you can use a bundle as the source of a shape elsewhere, and you can
use a bundle as a source of data to load a cursor.  After which you can do all the usual value cursor things
like <code>out</code> statements and so forth.</p><p>In order to call procedures with argument bundles more readily from other languages, the JSON output now includes additional
information about where procedure arguments originated; The field with this information is creatively called &quot;argOrigin:&quot;
and it has 3 forms.</p><ul><li>&quot;arg_name&quot; -&gt; the argument is not an expansion of anything</li><li>&quot;T arg_name&quot; -&gt; the argument came from <code>like T</code><ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be arg<em>name</em></li><li>if T is procedure arguments <code>like p1 arguments</code> then you&#x27;ll get  &quot;p1[arguments] arg_name&quot;</li></ul></li><li>&quot;name T arg_name&quot; -&gt; the argument came from <code>name like T</code> (a named bundle)<ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be T_arg_name</li><li>T could be procedure arguments as above</li></ul></li><li>If the source of an argument was a cursor or argument bundle name you get instead that thing&#x27;s shape source name<ul><li>this is always better because cursor names and bundle names are not globally unique.</li></ul></li><li>If the cursor had an anonymous source (e.g. <code>like select 1 x</code>) then you get the useless shape name &quot;select&quot;<ul><li>this is an indicator that you should make some ad hoc struct for this procedure because there is no useful name for the arg bundle&#x27;s type</li></ul></li></ul><p>None of this matters unless you&#x27;re trying to make wrappers for a CQL procedure for some other language
and you&#x27;d like to have your wrapper deal with structs rather than all loose arguments.  the JSON
basically tells you the structs.</p><p>Interestingly, argument bundles resulted in a significant reduction of code in the compiler.  The argument bundle
name has to be usable in the contexts where a cursor was previously usable.  It is another source of shaped data.
Getting that to work  proved to be super simple as the two forms look almost identical to the compiler -- no coincidence there.
So very little code was required to make <code>from [cursor_name]</code> work with <code>from [any_shape_name]</code> in the half dozen or so places
that this construct is allowed (e.g. procedure call arguments, insert statements, etc.).  However, there was as
much code associated with <code>from arguments</code> as there was <code>from cursor_name</code>.  And the code was nearly identical..</p><p>When argument bundles were introduced the natural thing to do was to create an artifical bundle called &quot;arguments&quot; which
represents the bundle that is ALL the arguments.  With that done, all the code for <code>from arguments</code> could be deleted
because <code>arguments</code> itself was a valid shape name.  Hence <code>insert into T from arguments</code> &quot;just works&quot;.  And so half
the rewrites were deleted.  The only cost was that the form <code>from arguments like shape</code> became the cursor form
<code>from arguments(like shape)</code> which only adds mandatory parens to a form that was largely unused anyway (there were two
cases in our entire codebase).  The cursor form is more general as you can do <code>from C(like A, like B)</code> to get the
fields that match <code>A</code> then those that match <code>B</code>.  Arguments get this for free as well (well, at the cost of parens).</p><p>So overall, this feature was added, and the compiler got smaller and cleaner.  Only the test suite had to grow.</p><p>Stay safe out there.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div><div class="col text--right"><a aria-label="Read more about Introducing  Argument Bundles" href="/blog/arg-bungle-intro"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/declare-enum-intro">Introducing Declare Enum</a></h2><div class="margin-vert--md"><time datetime="2020-12-03T00:00:00.000Z" class="blogPostDate_3bQP">December 3, 2020  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>There is an unfortunate pattern of hard coding constants in SQL which I think comes from the
fact that there&#x27;s not an especially good way to encode constants in SQL.  Things are a little
better In CG/SQL&#x27;s CQL language because it&#x27;s normal to run things through the pre-processor first
so you can do things like:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BUSINESS_TYPE_RESTAURANT 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BUSINESS_TYPE_LAUNDROMAT 2</span></div></div></div></div></div><p>Having done so, you could write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;Rico&#x27;s Laundry&quot;  name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   BUSINESS_TYPE_LAUNDROMAT type;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- by the time SQL sees this it becomes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business(name, type) values(&#x27;Rico&#x27;&#x27;s Laundry&#x27;, 2);</span></div></div></div></div></div><p>And at least you don&#x27;t have to see these loose &#x27;2&#x27; values all over. An especially unfortunate
form is the below, in which the auther is clearly crying for a symbol to use:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;Rico&#x27;s Laundry&quot;  name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2 type; /* laundromat */</span></div></div></div></div></div><p>But if we use <code>#define</code> the language knows nothing of the names and it can&#x27;t help you manage them
or export them consistently or anything like that.  I guess <code>#define</code> is pretty useful in several
langauges (C and C++) so you could maybe <code>#include</code> the macros somehow but that doesn&#x27;t seem
especially great.  And if you need them in Java you&#x27;re getting no help at all.</p><p>So to this world we add enumerated constants.  This is a bit short of enumerated types as we&#x27;ll
see later.  You can now write something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum business_type integer (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  restuarant,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  laundromat,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  corner_store = 11+3  /* math added for demo purposes only */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>After this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">select business_type.corner_store;</span></div></div></div></div></div><p>is the same as</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">select 14;</span></div></div></div></div></div><p>And that is exactly what SQLite will see, the literal 14.</p><p>What&#x27;s going on here?  There&#x27;s just a few rules:</p><ul><li>the enumeration can be any numeric type (bool, integer, long integer, real)</li><li>the values of the enumeration start at 1 (i.e. if there is no <code>= expression</code> the first item will be 1, not 0)</li><li>if you don&#x27;t specify a value, the next value is the previous value + 1</li><li>if you do specify a value it can be any constant expression and it will be cast to the type of the enumeration (even if thatis lossy)</li><li>the enumeration can refer to previous values in itself with no qualification <code>(big = 100.0, medium = big/2, small = medium/2)</code></li><li>the enumeration can refer to previously defined enumerations as usual <code>(code = business_type.restaurant)</code></li><li>Once the enumeration is defined you refer to its members in a fully qualified fashion <code>enum_name.member_name</code> elsewhere</li></ul><p>Why is this better than macros?  Well for one thing the enum values can be checked at their declaration site, so if you
have errors you will hear about them in a more reasonable place.  But additionally since the structure is known to the
compiler it can give you useful information in the outputs.</p><p>In the <code>.h</code> files you get:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">enum business_type {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__restaurant = 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__laundromat = 2,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__corner_store = 14</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div></div></div><p>In case of floating point values such as:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum floating real (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  one = 1.0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  two = 2.0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  e = 2.71828,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pi = 3.14159</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>You get:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// enum floating (floating point values)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__one 1.000000e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__two 2.000000e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__e 2.718280e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__pi 3.141590e+00</span></div></div></div></div></div><p>Which is unfortunately the best you can do since C has no floating point enums.</p><p>But in both cases the <code>enums</code> section of the JSON has the name of the enums and their members and values ready to go.
With these values you can readily generate (with moustache or something) the language interfaces of your choice.  This
is a real help if you&#x27;re trying to make helpers to call your CQL from say Java or something.</p><p>To do all this we needed to add some constant folding and general evaluation to the compiler.  It&#x27;s not much,
just the normal numeric types and null.  The supported operations include:</p><p><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, <code>|</code>, <code>&amp;</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code>, <code>~</code>, <code>and</code>, <code>or</code>, <code>not</code>, <code>==</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, the <code>cast</code> operator
and the <code>case</code> forms.  These are enough to make a lot of very interesting expressions, all of which are envaluated at
compile time.</p><p>While the constant folding was added to allow for rich <code>enum</code> expressions, there is also the <code>const()</code> primitive in the
language now which can appear anywhere a literal could appear.  This allows you do things that were previously not
allowed such as:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table something(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  x integer default const((1&lt;&lt;16)|0xf) /*  again the math is just for illustration */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The <code>const</code> form is also very useful in macros:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define SOMETHING const(12+3)</span></div></div></div></div></div><p>This form ensures that the constant will be evaluated at compile time. Const can also also nest so you can build these
kinds of macros from other macros or you can build enums this way. Anywhere you might need literals, you can use <code>const</code>.</p><p>Importantly, no enumerated data types were added to the language to do any of this.  The values can help you to
achieve some correctness by avoiding transcription mistakes but there is no additional type-safety provided here.
Indeed given the rich mix between these types in SQLite, and with SQLite having no knowledge of enumerations at
all it would be tricky to do a complete job.  Still, this might happen in the future.</p><p>But for now, declaring constants that are really an intimate part of your schema is now possible and the addition
of the constants to the <code>.h</code> files and the <code>.json</code> output should hopefully make these generally useful.  At least
we might see less of the hard-coded constant business with good values baked right into the schema declarations.</p><p>Happy Holidays.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div><div class="col text--right"><a aria-label="Read more about Introducing Declare Enum" href="/blog/declare-enum-intro"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/like-forms-tutorial">A quick tutorial on LIKE forms</a></h2><div class="margin-vert--md"><time datetime="2020-11-20T00:00:00.000Z" class="blogPostDate_3bQP">November 20, 2020  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Everyone knows the usual expression syntax <code>x LIKE y</code> to do a string match.  But the CQL compiler also uses
<code>LIKE</code> in a different way that&#x27;s powerful and important.  CQL has the notion of data shapes and you use
<code>LIKE</code> to refer to them.  The simplest source of a data shape, and maybe the most common, is a table.
Maybe something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> name </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> age </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Now suppose you want to write a procedure that can insert a row into that table, You could write</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> insert_into_T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name_ </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  age_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>This is all fine and well but what if T had 50 columns?  That gets old fast.  And how can you
be sure that you inserted the columns into T in the right order?  This second example also compiles
even though it&#x27;s clearly wrong:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T(id, name, age) values(age_, name_, id_);</span></div></div></div></div></div><p>And of course you can imagine things get only more complicated with more columns in T.</p><p>We started adding the <code>LIKE</code> form to ease these issues and to ensure some consistency in the APIs while preventing
simple transpostion errors.  So you can instead write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_into_T(like T)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>so here the <code>like T</code> in the argument list simply means &quot;make arguments that are the same as the columns of table T&quot; -- well,
almost. It also adds an <code>_</code> to the end of each name so you end up exactly the same declaration as the long form above.
But you won&#x27;t miss any arguments, and they&#x27;ll be in the right order.</p><p>And notice that we used <code>from arguments</code> to indicate that we wanted the values to come from the arguments in order. Again
this saves you from a lot of typing and a lot of error checking.  You can&#x27;t get the arguments in the wrong order.</p><p>These are the most basic patterns. But there are quite a few more.</p><p>Let&#x27;s suppose you want to write a procedure that returns in row with the highest age in the above.  Maybe you write
something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> highest_age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> M </span><span class="token operator" style="color:rgb(137, 221, 255)">or</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Here we made a cursor <code>M</code> that is the same as the cursor <code>C</code> and then we are going to generate a single row result
from the cursor.  Note that if you use a cursor name like <code>M</code> in an expression it refers to the hidden boolean
that says if the cursor has a row in it or not.  So <code>M</code> begins empty and we will load it if it&#x27;s empty or if the age
is higher than what we&#x27;ve already got.</p><p>Let&#x27;s show a few more of the forms.  Suppose we don&#x27;t want to return <code>name</code>, just the <code>id</code> and the <code>age</code>.  We can
change things up a tiny bit.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> highest_age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">99</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> M </span><span class="token operator" style="color:rgb(137, 221, 255)">or</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>So two things to notice.  We used an <em>ad hoc</em> shape, making a fake <code>select</code> statement that returns the shape we want.  This
select doesn&#x27;t run but it does define types and columns easily.  Two not null integers in this case.  Now <code>M</code> is not the
same as <code>C</code> so we can&#x27;t use the simplest form <code>fetch M from C</code> we have to use the more general form. </p><p>Fully expanded, what we wrote becomes:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FETCH</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">VALUES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>But as you can see, we didn&#x27;t have to type all those column names.  And that&#x27;s kind of the point of the <code>LIKE</code> construct.</p><p>So we&#x27;ve covered a bunch of the shape sources already:</p><ul><li>a table name</li><li>a cursor name</li><li>a select statement that gives the shape in an ad hoc fashion</li></ul><p>There are three more</p><ul><li>a view name </li><li>the return shape of a procedure that returns a result set</li><li>the arguments of a procedure</li></ul><p>View names are pretty simple, and they work the same as table names so we don&#x27;t need to discuss those. Let&#x27;s look
at some of the other uses with procedures.</p><p>Suppose we have a procedure that can return a result set shape but we want to be able to mock its results so we
can fake whatever result we need for testing.  </p><p>We&#x27;ll complicate this a bit adding a new table (keeping short table names for the sample to save typing)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> email </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>And here&#x27;s a procedure:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">email </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">inner</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">join</span><span class="token plain"> U </span><span class="token keyword" style="font-style:italic">on</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Now we want to be able to make any fake result we want, so maybe want a temp table. No problem:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> _init_fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">temp</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">exists</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_proc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> add_fake_result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> fake_results </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>The above is very generic and will maintain well.  You can see we made a temp table that will have
exactly the same shape as whatever <code>my_proc</code> returns.  In this case it becomes:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> _init_fake_results </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    age </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    email </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>And the rest are patterns we&#x27;ve seem before.</p><p>The last source of shapes are procedure arguments.  There&#x27;s lots of good cases for those, I wrote an <a href="https://cgsql.dev/blog/update" target="_blank" rel="noopener noreferrer">entry</a> on those previously but I&#x27;ll give a simple example here too.</p><p>Suppose we have this weird procedure:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">age_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_ </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> age_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">delete</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> name_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">delete</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>What if we wanted to log any errors that happen here?  Maybe make a verison that logs.  We can do it like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_and_log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> catch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;delete failed\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> catch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>The nice thing about this logging wrapper procedure is that if <code>delete_stuff</code> changes, the wrapper will change with it.</p><p>That covers all of the shape sources and as we saw we can use them to create things like cursors, tables, and argument lists.
We can use them to specify a subset of columns that might be of interest when fetching or updating cursors.  And we can use
them in one last way -- to restrict arguments to a particular shape.  Let&#x27;s see how that works by making the previous logger
a little different.  Here we added an argument which tells if we should look.  And that might look like it would
spoil the <code>from arguments</code> part of the forwarding, but there is the final way to use <code>LIKE</code>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_and_log2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> age_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deleting %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> name_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deleting %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>So this form lets you use some of your arguments, the ones that match a certain shape.  And as we saw in
the previous article you can also use <code>from C</code> to pass arguments where <code>C</code> is a cursor and in that case
you can also specify that arguments be matched by name <code>from C like shape</code>.  In both those cases the
formal parameter names of the called procedure are matched against the names of the shape and passed in
the order of the formals.  So this is like &quot;call by name&quot;, the fields of the cursor or the order of
arguments in the argument list might be different than the formals but you&#x27;ll get the correct items
in the correct order regardless, because it matches by name.</p><p>These forms can save you a lot of typing... and are excellent at avoiding errors and improving maintainability.
Where they appear in SQL statements, everything is expanded before it goes to SQLite so SQLite will see
normal syntax forms.  Which is good because obviously SQLite doesn&#x27;t know anything about this enhanced
<code>LIKE</code> business.</p><p>In the examples above there were only one or two columns with very short names, but in real world code
there can easily be dozens of columns with very long names.  In those cases, these forms really shine.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div><div class="col text--right"><a aria-label="Read more about A quick tutorial on LIKE forms" href="/blog/like-forms-tutorial"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/error-tracing-macro">Error Tracing Helper Macro</a></h2><div class="margin-vert--md"><time datetime="2020-11-18T00:00:00.000Z" class="blogPostDate_3bQP">November 18, 2020  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Following up on the last blog entry, I thought it would be useful to present a simple error tracing macro that you can use
to see what kind of error flow is going on when you&#x27;re having trouble understanding why a procedure is returning
an error code. The idea is we want to create a macro that we can use like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN_VERBOSE_STDERR_TRACING;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Some procedure(s) that you want to trace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END_VERBOSE_STDERR_TRACING;</span></div></div></div></div></div><p>We can do that with something like the below macros.  These particular ones cause the output to go to <code>stderr</code> via <code>fprintf</code> but if that isn&#x27;t what you need you can simply edit the macro. The macros looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- manually force tracing on by redefining the cql_error_trace macro</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BEGIN_VERBOSE_STDERR_TRACING \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#undef cql_error_trace\n&quot;; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#define cql_error_trace() fprintf(stderr, \&quot;CQL Trace at %s:%d in %s: %d %s\\n\&quot;, __FILE__, __LINE__, _PROC_, _rc_, sqlite3_errmsg(_db_))\n&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define END_VERBOSE_STDERR_TRACING \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#undef cql_error_trace\n&quot;; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#define cql_error_trace()\n&quot;</span></div></div></div></div></div><p>So basically it&#x27;s telling CQL to emit a <code>#define</code> into its output stream.  In this case:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace() fprintf(stderr, &quot;CQL Trace at %s:%d in %s: %d %s\n&quot;, __FILE__, __LINE__, _PROC_, _rc_, sqlite3_errmsg(_db_))</span></div></div></div></div></div><p>You could change that to any function you like, you can have it dump the errors where you like, or you can make it some dummy function you add so that you can set a breakpoint on it.</p><p>Whatever you do, do not leave your code with this sort of tracing enabled -- it&#x27;s far too expensive in terms of code size.  But it&#x27;s perfect if you have this one procedure that is failing and it&#x27;s hard for you to see where.</p><p>Obviously if you&#x27;re making a custom trace thingy you don&#x27;t need the macro at all, you can just emit your own <code>#define</code> with <code>@echo</code> as needed.</p><p>Note: <code>@echo</code> is quite a sledgehammer so don&#x27;t use it lightly and not in production code but it is quite helpful for this sort of thing.  CQL tests often use it to help make things visible to the tests.  If you use <code>@echo</code> in weird ways you might not get working code when the codegen changes in the future.</p><p>The relevant state that is available to you inside a macro like this is:</p><ul><li><code>__FILE__</code> the current filename (comes from the C pre-processor, this is the .c file name not the .sql)</li><li><code>__LINE__</code> the current line number (comes from the C pre-processor, this is the .c line number)</li><li><code>_rc_</code> the current SQLite result code (always the current return code in every CQL procedure that uses SQLite)</li><li><code>_db_</code> the current SQLite database pointer (always the current database in every CQL procedure that uses SQLite)</li><li><code>_PROC_</code> the current procedure name (CQL has a <code>#define</code> for this for you)</li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div><div class="col text--right"><a aria-label="Read more about Error Tracing Helper Macro" href="/blog/error-tracing-macro"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/error-tracing-intro">Introducing General Purpose Error Tracing</a></h2><div class="margin-vert--md"><time datetime="2020-11-16T00:00:00.000Z" class="blogPostDate_3bQP">November 16, 2020  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Today we made a couple of minor changes in the code generation to take care of some lingering issues.</p><p>The first is that when you did a <code>throw</code> inside a <code>catch</code> to basically rethrow the error, you would lose
the error code if something had succeeded within the catch handler.</p><p>The old codegen looked something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  catch_start_1: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;error\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cql_best_error(&amp;_rc_)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    goto cql_cleanup;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div></div></div><p>The problem being that while the <code>printf</code> above is fine and well, if you did any SQL operation then <code>_rc_</code> would be
clobbered and you&#x27;d end up throwing an unrelated error code.   <code>cql_best_error</code> would at least make sure it was
a failure code (<code>SQLITE_ERROR</code>) but the original error code was lost.</p><p>The new code looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  catch_start_1: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _rc_thrown_ = _rc_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;error\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _rc_ = cql_best_error(_rc_thrown_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    goto cql_cleanup;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div></div></div><p>So now if there are db operations, the original return code is still preserved.  Note:  you still lose <code>sqlite3_errmsg()</code> because
SQLite doesn&#x27;t know that cleanup logic is running.</p><p>This brings us to the second new thing: general purpose error traces.</p><p>Error checking of result codes happens very consistently in CQL output.  The usual pattern looks something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _rc_ = cql_exec(_db_,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;SAVEPOINT base_proc_savepoint&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (_rc_ != SQLITE_OK) goto cql_cleanup;</span></div></div></div></div></div><p>or if it&#x27;s inside a try block a little different... very little actually</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _rc_ = cql_exec(_db_,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;RELEASE SAVEPOINT base_proc_savepoint&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (_rc_ != SQLITE_OK) goto catch_start_8;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ... the rest of the try block</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div></div></div><p>Basically if the local <code>_rc_</code> doersn&#x27;t match the necessary condition we <code>goto</code> the appropriate error label... either the relevant
catch block or else the procedure&#x27;s cleanup code.</p><p>We generalize this a bit now so that it looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (_rc_ != SQLITE_OK) { cql_error_trace(); goto cql_cleanup; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- or, in a catch...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (_rc_ != SQLITE_OK) { cql_error_trace(); goto catch_start_8; }</span></div></div></div></div></div><p>Now the default implementation of <code>cql_error_trace()</code> is in <code>cqlrt.h</code> which you can and should customize. I&#x27;ll be writing more
about that later but suffice to say you&#x27;re supposed to replace <code>cqlrt.h</code> and <code>cqlrt.c</code> with suitable runtime helpers for your environment
while keeping <code>cqlrt_common.h</code> and <code>cqlrt_common.c</code> fixed.</p><p>So for instance, your <code>cqlrt.h</code> could look like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef CQL_TRACING_ENABLED</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// whatever tracing you want, for example this might help in test code.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace() \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fprintf(stderr, &quot;Error at %s:%d in %s: %d %s\n&quot;, __FILE__, __LINE__, _PROC_, _rc_, sqlite3_errmsg(_db_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>So then when you need to debug problems involving lots of error recovery you can watch the entire chain of events easily.</p><p>Note that there are some useful variables there:</p><p>In any procedure <code>_db_</code> is the current database and <code>_rc_</code> is the most recent return code from SQLite.  <code>__FILE__</code> and <code>__LINE__</code>
of course come from the preprocessor.  and <code>_PROC_</code> (one underscore) is now generated by the compiler.  Every procedure&#x27;s
body now begins with:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#undef _PROC_</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define _PROC_ &quot;the_current_procedure&quot;</span></div></div></div></div></div><p>So by defining your own cql_error_trace macro you can cause whatever logging you need to happen.  Note this can be
very expensive indeed because this happens a lot and even the string literals needed are a significant cost. So generally
this should be off for production builds and enabled as needed for debug builds.</p><p>The default implementation is just an empty block</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace()</span></div></div></div></div></div><p>But the hook is enough to light up whatever logging you might need, and you can use <code>sqlite3_errmsg()</code> before that message is gone.</p><p>Good hunting.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div><div class="col text--right"><a aria-label="Read more about Introducing General Purpose Error Tracing" href="/blog/error-tracing-intro"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.480d1f30.js"></script>
<script src="/runtime~main.34082030.js"></script>
<script src="/main.b815b31d.js"></script>
<script src="/1.2e95473d.js"></script>
<script src="/2.0c45b020.js"></script>
<script src="/3.d04889a6.js"></script>
<script src="/6875c492.4d2a66c0.js"></script>
<script src="/3e3a85bc.4f802e0d.js"></script>
<script src="/80400c32.4e933fdb.js"></script>
<script src="/fc3479db.6383568e.js"></script>
<script src="/c3370886.e105e932.js"></script>
<script src="/517fa2ac.bf08fa3f.js"></script>
<script src="/7e9fb3d2.1230d0a1.js"></script>
</body>
</html>